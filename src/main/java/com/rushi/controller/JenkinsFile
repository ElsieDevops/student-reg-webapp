properties([pipelineTriggers([githubPush()])])

node{
    def mavenHome = tool name: 'maven-3.9.11', type: 'maven'
    def TomcatSystemIP = "18.213.3.192"
    def TomcatserverSSHUserName = "ec2-user"
    try {
    stage("Git clone") { 
        git branch: 'development', changelog: true, credentialsId: 'Github_Credentials', poll: true, url: 'https://github.com/ElsieDevops/student-reg-webapp.git'
     }
     stage("maven build") {
         sh "${mavenHome}/bin/mvn clean package"
     }
     stage("maven verify and sonar scan") {
         withCredentials([string(credentialsId: 'SonarToken', variable: 'SonarTokenU')]) {
             sh """
             ${mavenHome}/bin/mvn clean verify sonar:sonar -Dsonar.token=${SonarTokenU}
             """
            }
         }
    stage("maven deploy nexus") {
        sh "${mavenHome}/bin/mvn clean deploy"
    }
    stage("deploy to tomcat") {
       sshagent(['Tomcat_server_SSHCredentials']) {
           sh "scp -o StrictHostKeyChecking=no target/student-reg-webapp.war ${TomcatserverSSHUserName}@${TomcatSystemIP}:/opt/tomcat/webapps/student-reg-webapp.war"
       }
     }
     currentBuild.result = 'SUCCESS'
  } catch(err) {
       currentBuild.result = 'FAILURE'
        echo "Build failed: ${err}"
  } finally {
      def buildStatus = currentBuild.result ?: 'SUCCESS'
        def color = (buildStatus == 'SUCCESS') ? '#28a745' : '#dc3545'
        def bgColor = (buildStatus == 'SUCCESS') ? '#eafbea' : '#fdecea'
        def emoji = (buildStatus == 'SUCCESS') ? '✅' : '❌'
        def title = (buildStatus == 'SUCCESS') ? 'Build Successful!' : 'Build Failed!'

        emailext(
            subject: "${emoji} ${env.JOB_NAME} - Build #${env.BUILD_NUMBER} - ${buildStatus}",
            body: """
            <html>
            <body style="font-family: Arial, sans-serif; color: #222;">

                <div style="border-left: 6px solid ${color}; background-color: ${bgColor}; padding: 15px;">
                    <h2 style="color: ${color};">${emoji} ${title}</h2>
                    <table style="border-collapse: collapse; width: 100%; margin-top: 10px;">
                        <tr>
                            <td style="padding: 8px;"><b>Job Name:</b></td>
                            <td style="padding: 8px;">${env.JOB_NAME}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px;"><b>Build Number:</b></td>
                            <td style="padding: 8px;">#${env.BUILD_NUMBER}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px;"><b>Status:</b></td>
                            <td style="padding: 8px; color: ${color}; font-weight: bold;">${buildStatus}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px;"><b>Branch:</b></td>
                            <td style="padding: 8px;">development</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px;"><b>Build URL:</b></td>
                            <td style="padding: 8px;"><a href="${env.BUILD_URL}" style="color: #007bff;">View Details</a></td>
                        </tr>
                    </table>

                    <p style="margin-top: 20px;">
                        For more details, please review the Jenkins console log or SonarQube dashboard.
                    </p>
                </div>

            </body>
            </html>
            """,
            to: 'okuelsie@gmail.com',
            mimeType: 'text/html'
        )
  }
}
